---
- name: "clean old repo"
  file: path="{{ project_path }}" state=absent

- name: "ensure repo projects directory"
  file: path="~/projects" state=directory

- name: "fetch repo"
  git:
    repo: "{{ repo_url }}"
    version: "{{ git_ref }}"
    accept_hostkey: yes
    force: True
    dest: "{{ project_path }}"
    ssh_opts: "-o ForwardAgent=yes"

- name: "install repo dependencies"
  command: bash -lc "mix deps.get" chdir="{{ project_path }}"
  environment:
    MIX_ENV: "{{ mix_env }}"

- name: "dry compile"
  command: bash -lc "MIX_ENV=prod mix compile" chdir="{{ project_path }}"

- name: "get release version"
  command: bash -lc "mix run -e 'IO.puts \"RELEASE_VERSION=\" <> Mix.Project.config[:version]' | grep RELEASE_VERSION | sed 's/RELEASE_VERSION=//'" chdir="{{ project_path }}"
  register: app_version_result
- set_fact: app_version="{{ app_version_result.stdout }}"

- name: "build release"
  command: bash -lc 'SERVER=1 mix release' chdir="{{ project_path }}"
  environment:
    MIX_ENV: "{{ mix_env }}"
    PORT: "{{ app_port }}"

- name: add and commit the release
  command: git add -A chdir="{{ project_path }}"
- command: git commit -m "recompiled assets for {{ env }} --skip-ci" chdir="{{ project_path }}"
  ignore_errors: yes
- shell: git tag -a "{{ app_version }}" -m 'build server compiled' chdir="{{ project_path }}"
  sudo: yes
  ignore_errors: yes

- name: push this up to origin
  command: git push origin {{ git_ref }} --tags chdir="{{ project_path }}"
  ignore_errors: yes
